import mysql from 'mysql2/promise';
import dotenv from 'dotenv';
import fs from 'fs';

dotenv.config();

async function exportDump() {
  const databaseUrl = process.env.DATABASE_URL;
  if (!databaseUrl) {
    console.error('DATABASE_URL not set in .env');
    process.exit(1);
  }

  let conn;
  try {
    conn = await mysql.createConnection(databaseUrl);
    const [tables] = await conn.query("SHOW TABLES");
    const tableNames = tables.map(row => Object.values(row)[0]);

    let out = '';
    out += `-- SQL Dump generated by export-mysql-dump.js\n`;
    out += `-- Database: ${databaseUrl}\n\n`;

    for (const t of tableNames) {
      // DROP TABLE IF EXISTS
      out += `DROP TABLE IF EXISTS \`${t}\`;\n`;

      // Get CREATE TABLE
      const [createRes] = await conn.query(`SHOW CREATE TABLE \`${t}\``);
      const createSql = createRes[0]['Create Table'];
      out += createSql + ';\n\n';

      // Get rows
      const [rows] = await conn.query(`SELECT * FROM \`${t}\``);
      if (rows.length > 0) {
        const cols = Object.keys(rows[0]).map(c => `\`${c}\``).join(', ');
        for (const row of rows) {
          const vals = Object.values(row).map(v => {
            if (v === null) return 'NULL';
            if (typeof v === 'number') return v;
            // Escape single quotes
            const s = String(v).replace(/\\'/g, "''").replace(/\r/g, '\\r').replace(/\n/g, '\\n');
            return `'${s.replace(/'/g, "\\'")}'`;
          }).join(', ');
          out += `INSERT INTO \`${t}\` (${cols}) VALUES (${vals});\n`;
        }
        out += '\n';
      }
    }

    fs.writeFileSync('import.sql', out);
    console.log('SQL dump written to import.sql');
    await conn.end();
  } catch (err) {
    console.error('Error exporting dump:', err.message || err);
    if (conn) await conn.end();
    process.exit(1);
  }
}

exportDump();
